name: Global CI/CD Pipeline

on:
  push:
    branches: [ staging, main ]

env:
  AWS_REGION: eu-central-1
  ECR_REPO: online-boutique

jobs:
  build:
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install Skaffold
        run: |
          curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
          sudo install skaffold /usr/local/bin/

      - name: Build and Push to ECR (Versioned & Latest)
        run: |
          skaffold build --tag=${{ github.run_number }} \
            --cache-artifacts=true \
            --default-repo=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPO }} \
            --push=true

          skaffold build --tag=latest \
            --cache-artifacts=true \
            --default-repo=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPO }} \
            --push=true

  deploy:
    needs: [build]
    if: always() && (needs.build.result == 'success' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install Skaffold & Kubectl
        run: |
          curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
          sudo install skaffold /usr/local/bin/

      - name: Set Variables
        id: vars
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "cluster=online-boutique-production" >> $GITHUB_OUTPUT
            echo "ns=production" >> $GITHUB_OUTPUT
            echo "profile=production" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT # Ð”Ð»Ñ Prod Ð·Ð°Ð²Ð¶Ð´Ð¸ Ð±ÐµÑ€ÐµÐ¼Ð¾ Ð¾ÑÑ‚Ð°Ð½Ð½Ñ–Ð¹ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐµÐ½Ð¸Ð¹ Ð·Ñ– Staging
          else
            echo "cluster=online-boutique-staging" >> $GITHUB_OUTPUT
            echo "ns=staging" >> $GITHUB_OUTPUT
            echo "profile=staging" >> $GITHUB_OUTPUT
            echo "tag=${{ github.run_number }}" >> $GITHUB_OUTPUT # Ð”Ð»Ñ Staging Ð´ÐµÐ¿Ð»Ð¾Ñ—Ð¼Ð¾ Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ñƒ Ð·Ð±Ñ–Ñ€ÐºÑƒ
          fi

      - name: Deploy to Cluster
        run: |
          aws eks update-kubeconfig --name ${{ steps.vars.outputs.cluster }} --region ${{ env.AWS_REGION }}
          
          skaffold deploy \
            -p ${{ steps.vars.outputs.profile }} \
            --tag=${{ steps.vars.outputs.tag }} \
            --default-repo=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPO }}

      - name: Health Check
        run: |
          kubectl rollout status deployment/frontend -n ${{ steps.vars.outputs.ns }} --timeout=120s

      - name: Get Frontend URL and Summary
        run: |
          sleep 15
          
          URL=$(kubectl get svc frontend-external -n ${{ steps.vars.outputs.ns }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          echo "### ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ñƒ ${{ steps.vars.outputs.ns }} ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¸Ð¹!" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Tag:** \`${{ steps.vars.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$URL" ]; then
            echo "**ðŸŒ ÐŸÐ¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð½Ð° Frontend:** [http://$URL](http://$URL)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Ð‘Ð°Ð»Ð°Ð½ÑÑƒÐ²Ð°Ð»ÑŒÐ½Ð¸Ðº Ñ‰Ðµ Ñ–Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÑ”Ñ‚ÑŒÑÑ. Ð—Ð°Ñ‡ÐµÐºÐ°Ð¹Ñ‚Ðµ ÐºÑ–Ð»ÑŒÐºÐ° Ñ…Ð²Ð¸Ð»Ð¸Ð½ Ñ‚Ð° Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ AWS." >> $GITHUB_STEP_SUMMARY
          fi