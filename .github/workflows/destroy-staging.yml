name: Destroy Staging
on: [workflow_dispatch]

jobs:
  cleanup-and-destroy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Update Kubeconfig
        run: aws eks update-kubeconfig --name online-boutique-staging --region eu-central-1

      - name: Force Clean Kubernetes Resources
        run: |
            echo "=== Початок примусового очищення Kubernetes ресурсів ==="
            
            echo "1. Видалення Ingress ресурсів..."
            kubectl delete ingress -n staging --all --timeout=60s || true
            
            echo "2. Видалення Service з типом LoadBalancer..."
            kubectl get svc -n staging -o json | jq -r '.items[] | select(.spec.type=="LoadBalancer") | .metadata.name' | while read svc; do
              echo "   Видалення сервісу: $svc"
              kubectl delete svc $svc -n staging --timeout=60s || true
            done
            
            echo "3. Видалення TargetGroupBindings..."
            kubectl get targetgroupbindings -n staging --no-headers 2>/dev/null | awk '{print $1}' | xargs -I {} kubectl delete targetgroupbinding {} -n staging --timeout=30s || true
            
            echo "4. Видалення всіх ресурсів в namespace staging..."
            kubectl delete namespace staging --timeout=120s || true
            
            echo "5. Очікування видалення AWS Load Balancers (60 секунд)..."
            sleep 60
            
            echo "=== Очищення Kubernetes ресурсів завершено ==="

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        
      - name: Terraform Init & Destroy
        working-directory: ./terraform
        run: |
          terraform init -backend-config='backend-staging.hcl'
          terraform destroy -auto-approve -var-file='staging.tfvars'