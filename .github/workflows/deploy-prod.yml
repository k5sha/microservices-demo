name: Production CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install Skaffold
        run: |
          curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
          sudo install skaffold /usr/local/bin/

      - name: Deploy to Production
        env:
          DEFAULT_REPO: ${{ steps.login-ecr.outputs.registry }}/online-boutique
          PROFILE: 'production'
        run: |
          aws eks update-kubeconfig --name online-boutique-production --region eu-central-1
          
          skaffold deploy -p $PROFILE --default-repo=$DEFAULT_REPO

      - name: Health Check and Rollback
        run: |
          if ! kubectl rollout status deployment/frontend -n production --timeout=120s; then
            echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½-ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ñ–! Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð²Ñ–Ð´ÐºÐ°Ñ‚..."
            kubectl rollout undo deployment/frontend -n production
            exit 1
          fi

      - name: Get Frontend URL
        run: |
          sleep 25
          URL=$(kubectl get svc frontend-external -n production -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          if [ -n "$URL" ]; then
            echo "### ðŸš€ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸŒ Frontend URL:** [http://$URL](http://$URL)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Ð‘Ð°Ð»Ð°Ð½ÑÑƒÐ²Ð°Ð»ÑŒÐ½Ð¸Ðº Ñ‰Ðµ Ñ–Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÑ”Ñ‚ÑŒÑÑ, Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð±ÑƒÐ´Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ðµ Ð·Ð° ÐºÑ–Ð»ÑŒÐºÐ° Ñ…Ð²Ð¸Ð»Ð¸Ð½." >> $GITHUB_STEP_SUMMARY
          fi